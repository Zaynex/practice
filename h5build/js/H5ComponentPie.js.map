{"version":3,"sources":["H5ComponentPie.js"],"names":["H5ComponentPie","name","cfg","component","H5ComponentBase","w","width","h","height","cns","document","createElement","ctx","getContext","$","css","append","r","beginPath","fillStyle","strokeStyle","lineWidth","arc","Math","PI","fill","stroke","colors","sAngel","eAngel","aAngel","step","data","length","i","item","color","pop","moveTo","text","per","x","sin","y","cos","draw","clearRect","find","reSort","on","setTimeout","console","log","list","compare","domA","domB","offsetA","offset","offsetB","shadowA_x","left","shadowA_y","top","shadowB_x","shadowB_y","intersect_x","intersect_y","reset","parseInt","willReset","each","domTarget","push"],"mappings":"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","file":"H5ComponentPie.js","sourcesContent":["/*饼图*/\r\nvar H5ComponentPie = function(name, cfg){\r\n  var component = new H5ComponentBase(name, cfg);\r\n\r\n  var w = cfg.width;\r\n  var h = cfg.height;\r\n\r\n  //加入一个画布\r\n  var cns = document.createElement('canvas');\r\n  var ctx = cns.getContext('2d');\r\n  cns.width = ctx.width = w;\r\n  cns.height = cns.height = h;\r\n  $(cns).css('zIndex', 1);\r\n  component.append(cns);\r\n\r\n\r\n  var r = w /2;\r\n\r\n  //  加入一个底图层\r\n  ctx.beginPath();\r\n  ctx.fillStyle='#eee';\r\n  ctx.strokeStyle='#eee';\r\n  ctx.lineWidth = 1;\r\n  ctx.arc(r,r,r,0,2*Math.PI);\r\n  ctx.fill();\r\n  ctx.stroke();\r\n\r\n  //绘制数据层\r\n  var cns = document.createElement('canvas');\r\n  var ctx = cns.getContext('2d');\r\n  cns.width = ctx.width = w;\r\n  cns.height = ctx.height =h;\r\n\r\n  $(cns).css('zIndex',2);\r\n  component.append(cns);\r\n  \r\n  var colors = ['red','green','blue','#a00','orange']; //  备用颜色\r\n  var sAngel = 1.5 * Math.PI; //  设置开始的角度在 12 点位置\r\n  var eAngel = 0; //  结束角度\r\n  var aAngel = Math.PI*2; //  100%的圆结束的角度 2pi = 360\r\n\r\n  //数据层\r\n  var step = cfg.data.length;\r\n  for(var i = 0;i < step; i++){\r\n    var item = cfg.data[i];\r\n    var color = item[2] || (item[2] = colors.pop());\r\n    \r\n    eAngel = sAngel + aAngel * item[1];\r\n\r\n\r\n    ctx.beginPath();\r\n    ctx.fillStyle = color;\r\n    ctx.strokeStyle = color;\r\n    ctx.lineWidth = .1;\r\n\r\n\r\n    ctx.moveTo(r, r);\r\n    ctx.arc(r,r,r, sAngel, eAngel);\r\n    ctx.fill();\r\n    ctx.stroke();\r\n    sAngel = eAngel;\r\n\r\n    //加入所有项目的文本以及百分比\r\n    var text= $('<div class=\"text\"></div>');\r\n    text.text(cfg.data[i][0]);\r\n    var per = $('<div class=\"per\"></div>')\r\n    per.text(cfg.data[i][1]*100 + \"%\");\r\n    text.append(per);\r\n    var x = r + Math.sin(0.3*Math.PI-sAngel) * r;\r\n    var y = r + Math.cos(0.3*Math.PI-sAngel) * r;\r\n\r\n\r\n    if(x > w/2){\r\n      text.css('left', x/2);\r\n    }else{\r\n      text.css('right', (w-x)/2+10);\r\n    }\r\n    if(y > h/2){\r\n      text.css('top', y/2);\r\n    }else{\r\n      text.css('bottom', (h-y)/2);      \r\n    }\r\n    if( cfg.data[i][2] ){\r\n      text.css('color',cfg.data[i][2]); \r\n    }\r\n    text.css('opacity',0);\r\n    component.append(text);\r\n  }\r\n\r\n  //蒙版层\r\n  var cns = document.createElement('canvas');\r\n  var ctx = cns.getContext('2d');\r\n  cns.width = ctx.width = w;\r\n  cns.height = ctx.height =h;\r\n  $(cns).css('zIndex',3);\r\n  component.append(cns);\r\n\r\n\r\n  // ctx.beginPath();\r\n  ctx.fillStyle='#eee';\r\n  ctx.strokeStyle='#eee';\r\n  ctx.lineWidth = 1;\r\n\r\n\r\n  // ctx.arc(r,r,r,0,2*Math.PI);\r\n  // ctx.fill();\r\n  // ctx.stroke();\r\n\r\n  var draw = function(per){\r\n\r\n    ctx.clearRect(0,0, w, h);\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(r, r);\r\n\r\n\r\n    if(per <= 0){\r\n      ctx.arc(r, r, r, 0, 2*Math.PI);\r\n      component.find('.text').css('opacity',0);\r\n    }else{\r\n     ctx.arc(r, r, r, sAngel, sAngel+2*Math.PI*per, true);  \r\n    }\r\n    ctx.fill();\r\n    ctx.stroke();\r\n\r\n    if(per >= 1){\r\n      component.find('.text').css('transition','all 0s');\r\n      H5ComponentPie.reSort( component.find('.text') );\r\n      component.find('.text').css('transition','all 1s');\r\n      component.find('.text').css('opacity',1);\r\n      ctx.clearRect(0,0,w,h);\r\n  }\r\n}\r\n  draw(0);\r\n  component.on('onLoad',function(){\r\n    //  饼图生长动画\r\n      for(i = 0; i <100; i++){\r\n        (function(i){\r\n          setTimeout(function(){\r\n            draw(i/100+0.1);\r\n            console.log(i);\r\n          }, i*10 + 500);\r\n        })(i)\r\n      }\r\n  });\r\n  component.on('onLeave',function(){\r\n    //  饼图退场动画\r\n      for(i = 0; i < 100; i++){\r\n        (function(i){\r\n          setTimeout(function(){\r\n            draw(1-i/100);\r\n          }, i*10);\r\n        })(i)\r\n      }\r\n  });\r\n  return component;\r\n}\r\n\r\n\r\n\r\n//  重排项目文本元素\r\nH5ComponentPie.reSort = function( list ){\r\n\r\n  //  1. 检测相交\r\n  var compare = function(domA, domB){\r\n    var offsetA = $(domA).offset();\r\n    var offsetB = $(domB).offset();\r\n\r\n    var shadowA_x = [offsetA.left, $(domA).width() + offsetA.left];\r\n    var shadowA_y = [offsetA.top, $(domA).height() + offsetA.top];\r\n\r\n    var shadowB_x = [offsetB.left, $(domB).width() + offsetB.left];\r\n    var shadowB_y = [offsetB.left, $(domB).height() + offsetB.top];\r\n\r\n     //  检测 x\r\n    var intersect_x = ( shadowA_x[0] > shadowB_x[0] && shadowA_x[0] < shadowB_x[1] ) || ( shadowA_x[1] > shadowB_x[0] &&  shadowA_x[1] < shadowB_x[1]  );\r\n\r\n    //  检测 y 轴投影是否相交\r\n    var intersect_y = ( shadowA_y[0] > shadowB_y[0] && shadowA_y[0] < shadowB_y[1] ) || ( shadowA_y[1] > shadowB_y[0] &&  shadowA_y[1] < shadowB_y[1]  );\r\n    return intersect_x && intersect_y;\r\n  }\r\n\r\n\r\n  //  2. 错开重排\r\n  var reset = function( domA, domB ){\r\n\r\n    //这里只是让垂直方向不相交\r\n    if( $(domA).css('top') != 'auto' ){\r\n\r\n      $(domA).css('top', parseInt($(domA).css('top')) + $(domB).height() );\r\n    }\r\n    if( $(domA).css('bottom') != 'auto' ){\r\n\r\n      $(domA).css('bottom', parseInt($(domA).css('bottom')) + $(domB).height() );\r\n    }\r\n\r\n  };\r\n\r\n  //  定义将要重排的元素\r\n  var willReset = [list[0]];\r\n\r\n  $.each(list,function(i,domTarget){\r\n    if( compare(willReset[willReset.length-1] , domTarget ) ){\r\n      willReset.push(domTarget);  //  不会把自身加入到对比\r\n    }\r\n  });\r\n\r\n  if(willReset.length > 1 ){\r\n      $.each(willReset,function(i,domA){\r\n          if( willReset[i+1] ){\r\n            reset(domA,willReset[i+1]);\r\n          }\r\n      });\r\n      H5ComponentPie.reSort( willReset );\r\n  }\r\n}"]}